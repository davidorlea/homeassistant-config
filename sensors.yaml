- platform: moon
- platform: openweathermap
  api_key: !secret openweathermap_api_key
  forecast: true
  monitored_conditions:
    - clouds
    - humidity
    - pressure
    - temperature
    - weather
- platform: dwd_pollen
  partregion_ids:
    - 41
  include_days:
    - today
    - tomorrow

- platform: systemmonitor
  resources:
    - type: load_1m
    - type: load_5m
    - type: load_15m
    - type: processor_use
    - type: memory_use_percent
    - type: disk_use_percent
      arg: /
    - type: last_boot
- platform: uptime

- platform: mqtt
  state_topic: 'smarty/esp8266-377332/$system'
  name: 'Outdoor Frontdoor Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-377332/$system'
  name: 'Outdoor Frontdoor Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-377332/$system'
  name: 'Outdoor Frontdoor Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-377332/$system'
  name: 'Outdoor Frontdoor Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-3dbc1d/$system'
  name: 'Outdoor Backdoor Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3dbc1d/$system'
  name: 'Outdoor Backdoor Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3dbc1d/$system'
  name: 'Outdoor Backdoor Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3dbc1d/$system'
  name: 'Outdoor Backdoor Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-376566/$system'
  name: 'Kitchen Ceiling Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-376566/$system'
  name: 'Kitchen Ceiling Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-376566/$system'
  name: 'Kitchen Ceiling Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-376566/$system'
  name: 'Kitchen Ceiling Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-9541f4/$system'
  name: 'Kitchen Sideboard Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-9541f4/$system'
  name: 'Kitchen Sideboard Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-9541f4/$system'
  name: 'Kitchen Sideboard Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-9541f4/$system'
  name: 'Kitchen Sideboard Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-f94d00/$system'
  name: 'Kitchen Cabinet Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-f94d00/$system'
  name: 'Kitchen Cabinet Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-f94d00/$system'
  name: 'Kitchen Cabinet Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-f94d00/$system'
  name: 'Kitchen Cabinet Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-826269/$system'
  name: 'Living Room Ceiling Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-826269/$system'
  name: 'Living Room Ceiling Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-826269/$system'
  name: 'Living Room Ceiling Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-826269/$system'
  name: 'Living Room Ceiling Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-afc031/$system'
  name: 'Living Room Sofa Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-afc031/$system'
  name: 'Living Room Sofa Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-afc031/$system'
  name: 'Living Room Sofa Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-afc031/$system'
  name: 'Living Room Sofa Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-3e7098/$system'
  name: 'Bedroom Ceiling Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3e7098/$system'
  name: 'Bedroom Ceiling Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3e7098/$system'
  name: 'Bedroom Ceiling Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-3e7098/$system'
  name: 'Bedroom Ceiling Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-95791a/$system'
  name: 'Bedroom Bed Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95791a/$system'
  name: 'Bedroom Bed Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95791a/$system'
  name: 'Bedroom Bed Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95791a/$system'
  name: 'Bedroom Bed Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-95d69b/$system'
  name: 'Bedroom Ambient Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95d69b/$system'
  name: 'Bedroom Ambient Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95d69b/$system'
  name: 'Bedroom Ambient Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-95d69b/$system'
  name: 'Bedroom Ambient Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: mqtt
  state_topic: 'smarty/esp8266-121bb3/$system'
  name: 'Hall Ceiling Light Uptime'
  expire_after: '660'
  value_template: '{{now().replace(tzinfo=None) - now().fromtimestamp(as_timestamp(now()) - float(value_json.uptime)) }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-121bb3/$system'
  name: 'Hall Ceiling Light Firmware'
  expire_after: '660'
  value_template: '{{ value_json["firmware"]["version"] }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-121bb3/$system'
  name: 'Hall Ceiling Light WiFi RSSI'
  unit_of_measurement: '%'
  expire_after: '660'
  value_template: '{{ (float(value_json["wifi"]["rssi"]) + 100) * 2 }}'
- platform: mqtt
  state_topic: 'smarty/esp8266-121bb3/$system'
  name: 'Hall Ceiling Light WiFi IP'
  expire_after: '660'
  value_template: '{{ value_json["wifi"]["ip"] }}'

- platform: template
  sensors:
    period_of_day:
      value_template: >-
        {% if (as_timestamp(states.sun.sun.attributes.next_dusk)) - (as_timestamp(states.sun.sun.attributes.next_setting)) < 0 %}
          Dusk
        {% elif (as_timestamp(states.sun.sun.attributes.next_rising)) - (as_timestamp(states.sun.sun.attributes.next_dawn)) < 0 %}
          Dawn
        {% elif (states.sun.sun.attributes.elevation) < 0 %}
          Night
        {% else %}
          Day
        {% endif %}
      icon_template: >-
        {% if is_state('sun.sun', 'above_horizon') %}
          mdi:weather-sunny
        {% else %}
          mdi:weather-night
        {% endif %}

- platform: template
  sensors:
    dwd_pollen_today_41_ambrosia:
      unit_of_measurement: "%"
      value_template: >-
        {% set state = states("sensor.dwd_pollen_41_today_ambrosia") | int(-1) %}
        {% if state != (-1) %}
          {{ (state / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
    dwd_pollen_today_41_grass:
      unit_of_measurement: "%"
      value_template: >-
        {% set state = states("sensor.dwd_pollen_41_today_graeser") | int(-1) %}
        {% if state != (-1) %}
          {{ (state / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
    dwd_pollen_today_41_tree:
      unit_of_measurement: "%"
      value_template: >-
        {% set states = states("sensor.dwd_pollen_41_today_beifuss") | int(-1),
                        states("sensor.dwd_pollen_41_today_birke") | int(-1),
                        states("sensor.dwd_pollen_41_today_erle") | int(-1),
                        states("sensor.dwd_pollen_41_today_esche") | int(-1),
                        states("sensor.dwd_pollen_41_today_hasel") | int(-1),
                        states("sensor.dwd_pollen_41_today_roggen") | int(-1) %}
        {% if (-1) not in states %}
          {{ ((states | max) / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
    dwd_pollen_tomorrow_41_ambrosia:
      unit_of_measurement: "%"
      value_template: >-
        {% set state = states("sensor.dwd_pollen_41_tomorrow_ambrosia") | int(-1) %}
        {% if state != (-1) %}
          {{ (state / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
    dwd_pollen_tomorrow_41_grass:
      unit_of_measurement: "%"
      value_template: >-
        {% set state = states("sensor.dwd_pollen_41_tomorrow_graeser") | int(-1) %}
        {% if state != (-1) %}
          {{ (state / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
    dwd_pollen_tomorrow_41_tree:
      unit_of_measurement: "%"
      value_template: >-
        {% set states = states("sensor.dwd_pollen_41_tomorrow_beifuss") | int(-1),
                        states("sensor.dwd_pollen_41_tomorrow_birke") | int(-1),
                        states("sensor.dwd_pollen_41_tomorrow_erle") | int(-1),
                        states("sensor.dwd_pollen_41_tomorrow_esche") | int(-1),
                        states("sensor.dwd_pollen_41_tomorrow_hasel") | int(-1),
                        states("sensor.dwd_pollen_41_tomorrow_roggen") | int(-1) %}
        {% if (-1) not in states %}
          {{ ((states | max) / 6 * 100) | round(0) }}
        {% else %}
          unknown
        {% endif %}
      icon_template: >-
        mdi:flower-outline
